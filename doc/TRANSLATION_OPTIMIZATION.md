# 翻译优化说明

## 优化目标

解决原有翻译系统的以下问题：
1. **请求次数过多**：每页独立请求，快速耗尽 API 免费额度
2. **触发过于频繁**：快速滚动时每页都会触发翻译请求
3. **缺乏智能调度**：没有优先级管理和窗口预取机制
4. **上下文重复获取**：每次翻译都重复提取前后页文本

## 优化方案

### 1. 统一翻译调度器 (TranslationManager)

**位置**: `src/renderer/services/translation-manager.ts`

**核心功能**：
- 维护所有页面的翻译状态 (idle/queued/translating/done/error)
- 基于当前页实现窗口预取（默认 ±1 页）
- 任务队列按优先级排序（距离当前页越近优先级越高）
- 支持批量翻译（多页合并为一次请求）
- Rate limit 冷却机制

**配置参数**：
```typescript
{
  maxConcurrent: 1,    // 最大并发请求数
  batchSize: 3,        // 每批次翻译页数
  windowRadius: 1      // 预取窗口半径（当前页 ±N）
}
```

### 2. 窗口预取策略

**触发时机**：
- 当前页变化时（带 300ms debounce）
- 用户跳转到新页面时

**预取范围**：
- 当前页 = N
- 自动预取：N-1, N+1（可配置）
- 跳到 66 页：优先翻译 66，然后 65/67

**缓存复用**：
- 已翻译的页面不再重复请求
- 磁盘缓存 + 内存状态双层管理

### 3. 批量翻译

**原理**：
将多页内容用分隔符拼接，一次性发送给 AI：

```
【PAGE 1】
第一页内容...

###PAGE_SPLIT###

【PAGE 2】
第二页内容...
```

AI 返回时自动按分隔符拆分，分配给各页。

**效果**：
- 原来：3 页 = 3 次请求
- 现在：3 页 = 1 次请求
- 免费额度利用率提升 3 倍

### 4. Rate Limit 处理

当触发配额限制时：
- 自动进入 20 秒冷却期
- 队列中的任务暂停处理
- UI 提示用户等待时间

## 使用方式

### 基本使用

系统会自动管理翻译，用户无需手动操作：
1. 打开 PDF 后，当前页自动开始翻译
2. 滚动时，新页面会自动预取翻译
3. 已翻译的页面会缓存，下次打开立即显示

### 调整配置

在 `AppContext.tsx` 中修改 TranslationManager 初始化参数：

```typescript
new TranslationManager(services.cache, services.pdf, {
  maxConcurrent: 1,    // 并发数：建议保持 1
  batchSize: 3,        // 批量大小：3-5 页较合适
  windowRadius: 1      // 预取范围：1-2 页较合适
})
```

**建议配置**：
- 免费 API：`batchSize: 3, windowRadius: 1`
- 付费 API：`batchSize: 5, windowRadius: 2`

## 技术细节

### 状态流转

```
idle → queued → translating → done
                            ↘ error
```

### 组件通信

```
App.tsx (监听 currentPage)
  ↓
TranslationManager.requestWindow()
  ↓
队列调度 + 批量翻译
  ↓
通知 TranslationBlock 更新 UI
```

### 主进程 IPC

新增 `translateBatch` handler：
- 接收：`{ text, delimiter, pageCount }`
- 返回：拼接后的翻译结果
- 自动处理分隔符拆分

## 性能对比

| 指标 | 优化前 | 优化后 |
|------|--------|--------|
| 翻译 10 页请求数 | 10 次 | 4 次 (3+3+3+1) |
| 快速滚动触发 | 每页都触发 | 300ms 防抖 |
| 重复翻译 | 可能重复 | 状态管理避免 |
| 免费额度利用 | 10 页 | ~30 页 |

## 注意事项

1. **批量大小不宜过大**：太多页会导致单次请求 token 超限
2. **窗口半径适中**：太大会浪费配额，太小影响体验
3. **并发数建议为 1**：避免同时多个批量请求触发 rate limit
4. **冷却时间**：触发限制后会自动等待，无需手动干预

## 未来优化方向

1. 智能批量：根据页面文本长度动态调整 batchSize
2. 优先级队列：用户明确跳转的页面优先级更高
3. 后台预取：空闲时自动翻译整本书
4. 增量翻译：只翻译变化的部分

